{% extends "base.html" %}

{% block head_end %}

  <style type="text/css">

    h1, h2, h3 {
      text-align: center;
    }

    .temp {
      border: 2px solid red;
    }

  </style>

  <script type="text/javascript">

    var TESTING = false;

    $(function(){  
      if ("geolocation" in navigator) {
        start_locating();
      }
      update_pizzas();
      momentize();
    });


    /* -- moment-izing timestamps -- */

    function momentize() {
      $('.momentize').each(function(idx){ 
        $(this).html( moment($(this).data('timestamp')).fromNow() );
      });
    }


    /* -- pizzas ajax -- */

    // TODO: add template form name, post page url, test
    function post_pizza() {
      $.post('TODO', $('#someform').serialize(), function(data){
        console.log('post_pizza:', data);
        update_pizzas();
      });
    }

    function update_pizzas() {
      var ajax_url = (TESTING ? '/puwer/latest' : 'TODO');
      $.get(ajax_url, function(data){
        var r = $.parseJSON(data.javascript);
        $('#pizzas').html(r.markup);
      });
    }


    /* -- geolocation -- */

    var geo_success = function(position) {
    //   var ts = get_timestamp();
      var ts = moment().format('h:mm:ss a');
      var lat = position.coords.latitude;
      var lon = position.coords.longitude;
      var acc = position.coords.accuracy;

      $('#my-location').html( lat + ', <br>  ' + lon + '<br>  ' + acc );
      $('#my-location-updated').html( ts );

    };
    var geo_error = function(error) {
    //   console.log(error);
    };
    var geo_opts = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
    function start_locating() {
      var watchID = navigator.geolocation.watchPosition(geo_success, geo_error, geo_opts);
    }

    // function get_timestamp() {
    //   return Math.round( new Date().getTime() / 1000 );
    // }

  </script>

{% endblock %}

{% block main %}

  <div class="container" style="margin-bottom: 30px;">
    <div class="row">
      <div class="col-xs-12"> 
        <div class="page-header text-center">
          <h1>Hot Pizzas</h1>
          <p class="lead"><em>Driver Mode</em></p>
        </div>
<!--         <p class="text-center"><em>Welcome back, Foo Bar</em></p>
         -->        
<!--         <div class="alert alert-success alert-dismissable">
          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
          <strong>Congrats!</strong> A pizza has been sold.
        </div>
         -->        
        <pre>
My Location: 
  <span id="my-location"></span>
Last Updated: 
  <span id="my-location-updated"></span>
</pre>

        <hr>

<!--         <a href="" class="btn btn-primary btn-lg btn-block">Add a pizza</a>
        <p>post price, topping</p>        
        <hr>
         -->        

        <h2>My Pizzas</h2>

        <div id="pizzas" class="temp">
          foo
        </div>

        
        <h3><small><span class="glyphicon glyphicon-time"></span></small> En Route</h3>        
        {% for p in pizzas_to_deliver %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">{{ p.topping }} for {{ p.customer_fullname_or_username }} @ {{ p.price }}</h3>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-xs-12">
                  <p title="{{ p.request_time }}">Requested <span class="momentize" data-timestamp="{{ p.request_time }}">xxx</span></p>
                  <hr>
                  <a href="comgooglemaps://?daddr={{ p.customer_latitude }},{{ p.customer_longitude }}&amp;directionsmode=traffic" class="btn btn-primary btn-block">Directions</a>
                  <a href="tel:{{ p.customer_phone }}" class="btn btn-success btn-block">Call</a>  
                </div>      
              </div>
            </div>
          </div>
        {% endfor %}

        <h3><small><span class="glyphicon glyphicon-cutlery"></span></small> Available</h3>        
        <ul class="list-group">
          {% for p in pizzas_available %}
            <li class="list-group-item list-group-item-success" title="{{ p.cook_time }}">
              <span class="badge">{{ p.price }}</span>
              <strong>{{ p.topping }}</strong> <small><span class="momentize" data-timestamp="{{ p.cook_time }}"></span></small>
            </li>
          {% endfor %}
        </ul>
        
        <h3><small><span class="glyphicon glyphicon-check"></span></small> Delivered</h3>
        <ul class="list-group">
          {% for p in pizzas_delivered %}
            <li class="list-group-item list-group-item-success">
              {% if p.customer_fullname %}
                <strong>{{ p.customer_fullname }}</strong> <small>{{ p.topping }}</small>
              {% elif p.customer_username %}
                <strong>{{ p.customer_username }}</strong> <small>{{ p.topping }}</small>
              {% endif %}
            </li>
          {% endfor %}
        </ul>        
      </div>
    </div>
  </div>

{% endblock %}
